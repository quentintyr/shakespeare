<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FRC Robot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>FRC Robot Dashboard</h1>
  <div class="dashboard">
    <div class="logs-section">
      <div class="log-title">Robot Logs</div>
      <div class="log-container" id="robot-log">Loading log...</div>
    </div>
    <div class="widgets-main">
      <div class="widgets-section">
        <div class="widget-title">Hardware Status</div>
        <div class="widgets-container" id="hardware-widgets"></div>
      </div>
      <div class="widgets-section">
        <div class="widget-title">Subsystem Status</div>
        <div class="widgets-container" id="subsystem-widgets"></div>
      </div>
    </div>
  </div>
  <script>
    // Separate the hardware and subsystem widgets if needed
    const hardwareWidgets = [
      { id: 'lidar', label: 'Lidar' },
      { id: 'irLeft', label: 'IR Left' },
      { id: 'irRight', label: 'IR Right' },
      { id: 'sonicLeft', label: 'Sonic Left' },
      { id: 'sonicRight', label: 'Sonic Right' }
    ];

    const subsystemWidgets = [
      { id: 'arm', label: 'Arm' },
      { id: 'gripper', label: 'Gripper' },
      { id: 'elevator', label: 'Elevator' },
      { id: 'extender', label: 'Extender' },
      { id: 'vision', label: 'Vision' }
    ];

    function statusToClass(status) {
      if (status === "ok" || status === "ready" || status === "idle") return "status-green";
      if (status === "busy" || status === "working") return "status-yellow";
      return "status-red";
    }

    function getWidgetValue(id, data) {
      switch(id) {
        case "lidar":
          return data.lidar && data.lidar.distance !== undefined ? `Distance: ${data.lidar.distance}m` : "";
        case "irLeft":
          return data.irLeft && data.irLeft.distance !== undefined ? `Distance: ${data.irLeft.distance}m` : "";
        case "irRight":
          return data.irRight && data.irRight.distance !== undefined ? `Distance: ${data.irRight.distance}m` : "";
        case "sonicLeft":
          return data.sonicLeft && data.sonicLeft.distance !== undefined ? `Distance: ${data.sonicLeft.distance}m` : "";
        case "sonicRight":
          return data.sonicRight && data.sonicRight.distance !== undefined ? `Distance: ${data.sonicRight.distance}m` : "";
        case "arm":
          return data.arm && data.arm.position ? `Position: ${data.arm.position}` : "";
        case "gripper":
          return data.gripper && data.gripper.apple_gripped ? "Apple Gripped" : "Not Gripped";
        case "elevator":
          return data.elevator && data.elevator.position ? `Position: ${data.elevator.position}` : "";
        case "extender":
          return data.extender && data.extender.length !== undefined ? `Length: ${data.extender.length}m` : "";
        case "vision":
          return data.vision && data.vision.apple_detected ? "Apple Seen" : "Not Seen";
        default:
          return "";
      }
    }

    function renderWidgets(widgetList, containerId, data) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      widgetList.forEach(widget => {
        const status = data[widget.id]?.status || "error";
        const value = getWidgetValue(widget.id, data);
        const statusClass = statusToClass(status);
        container.innerHTML += `
          <div class="widget ${statusClass}">
            <div class="widget-label">${widget.label}</div>
            <div class="widget-value">${value}</div>
          </div>
        `;
      });
    }

    async function updateLog() {
      try {
        const logElem = document.getElementById('robot-log');
        const wasAtBottom = logElem.scrollHeight - logElem.scrollTop <= logElem.clientHeight + 5;
        const resp = await fetch('robot.log', {cache: "no-store"});
        if (!resp.ok) throw new Error('No log file');
        const text = await resp.text();
        logElem.innerHTML = text;
        if (wasAtBottom) logElem.scrollTop = logElem.scrollHeight;
      } catch (e) {
        document.getElementById('robot-log').textContent = "Unable to fetch log";
      }
    }

    async function updateStatus() {
      try {
        const resp = await fetch('status.json', {cache: "no-store"});
        if (!resp.ok) throw new Error('No status file');
        const data = await resp.json();
        renderWidgets(hardwareWidgets, "hardware-widgets", data);
        renderWidgets(subsystemWidgets, "subsystem-widgets", data);
      } catch (e) {
        renderWidgets(hardwareWidgets, "hardware-widgets", {});
        renderWidgets(subsystemWidgets, "subsystem-widgets", {});
      }
    }

    updateLog();
    updateStatus();
    setInterval(updateLog, 1000);
    setInterval(updateStatus, 1000);
  </script>
</body>
</html>